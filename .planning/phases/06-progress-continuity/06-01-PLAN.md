---
phase: 06-progress-continuity
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/init-director.sh
  - scripts/session-start.sh
  - scripts/state-save.sh
  - hooks/hooks.json
  - skills/onboard/templates/config-defaults.json
autonomous: true

must_haves:
  truths:
    - "New Director projects get a STATE.md with Progress, Recent Activity, Decisions Log, and Cost Summary sections"
    - "SessionStart hook outputs last_session date in its JSON context"
    - "SessionEnd hook updates STATE.md timestamps when the user closes their terminal"
    - "config.json includes a cost_rate field for token-to-dollar conversion"
  artifacts:
    - path: "scripts/init-director.sh"
      provides: "STATE.md init template with expanded format"
      contains: "Recent Activity"
    - path: "scripts/session-start.sh"
      provides: "SessionStart hook with last_session in JSON output"
      contains: "last_session"
    - path: "scripts/state-save.sh"
      provides: "SessionEnd hook script for timestamp persistence"
      contains: "Last session"
    - path: "hooks/hooks.json"
      provides: "Both SessionStart and SessionEnd hooks registered"
      contains: "state-save.sh"
  key_links:
    - from: "hooks/hooks.json"
      to: "scripts/state-save.sh"
      via: "SessionEnd hook command reference"
      pattern: "state-save\\.sh"
    - from: "hooks/hooks.json"
      to: "scripts/session-start.sh"
      via: "SessionStart hook command reference"
      pattern: "session-start\\.sh"
    - from: "scripts/init-director.sh"
      to: ".director/STATE.md"
      via: "heredoc template that creates the file"
      pattern: "Cost Summary"
---

<objective>
Establish the STATE.md format and session lifecycle hooks that all other Phase 6 plans depend on.

Purpose: STATE.md is the single source of truth for project state. Every other plan in this phase (syncer expansion, status skill, resume skill) reads from or writes to STATE.md. The format must be defined first so all consumers agree on the structure. The SessionEnd hook ensures STATE.md is never stale.

Output: Updated init script with rich STATE.md template, enhanced session-start hook, new state-save script for SessionEnd, updated hooks.json with both lifecycle hooks, and cost_rate in config defaults.
</objective>

<execution_context>
@/Users/noahrasheta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/noahrasheta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-progress-continuity/06-RESEARCH.md
@scripts/init-director.sh
@scripts/session-start.sh
@hooks/hooks.json
@skills/onboard/templates/config-defaults.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand STATE.md init template and add cost_rate to config defaults</name>
  <files>scripts/init-director.sh, skills/onboard/templates/config-defaults.json</files>
  <action>
Update the STATE.md heredoc in `scripts/init-director.sh` to use the expanded format from the research. The new template must include ALL of these sections in this exact order:

```markdown
# Project State

**Status:** Not started
**Last updated:** [timestamp]
**Last session:** [timestamp]

## Current Position

**Current goal:** None
**Current step:** None
**Current task:** None
**Position:** Not started

## Progress

No goals defined yet. Run `/director:onboard` to begin.

## Recent Activity

No activity yet.

## Decisions Log

No decisions recorded yet.

## Cost Summary

**Total:** 0 tokens ($0.00)
```

Replace `[timestamp]` with the actual date/time at creation using `$(date '+%Y-%m-%d %H:%M')` for Last updated and `$(date '+%Y-%m-%d')` for Last session.

IMPORTANT: The heredoc must NOT use single-quoted delimiter (like `'STATE_EOF'`) for the sections that need variable interpolation (the timestamps). Use appropriate quoting so the `date` commands get evaluated at init time.

Also update `skills/onboard/templates/config-defaults.json` to add a `cost_rate` field. Add it after the existing `max_retry_cycles` field:

```json
"cost_rate": 10.00
```

This represents dollars per million tokens. Default $10/1M tokens for Opus-class models. The syncer will read this when calculating cost estimates.
  </action>
  <verify>
Run `bash -n scripts/init-director.sh` to check for syntax errors. Grep for "Recent Activity", "Decisions Log", "Cost Summary" in the init script to confirm all sections present. Grep for "cost_rate" in config-defaults.json.
  </verify>
  <done>
init-director.sh creates STATE.md with all 6 sections (header, Current Position, Progress, Recent Activity, Decisions Log, Cost Summary). config-defaults.json includes cost_rate field with default value of 10.00.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SessionEnd hook and enhance session-start script</name>
  <files>scripts/state-save.sh, hooks/hooks.json, scripts/session-start.sh</files>
  <action>
**Create `scripts/state-save.sh`** -- a new script that runs on SessionEnd to update STATE.md timestamps. This must be lightweight (only timestamps, never recalculates progress).

```bash
#!/usr/bin/env bash
# state-save.sh
# Runs on SessionEnd hook to update STATE.md timestamps.
# Lightweight -- only updates timestamps, never recalculates progress.

# No project -- exit silently
if [ ! -f ".director/STATE.md" ]; then
  exit 0
fi

TIMESTAMP=$(date '+%Y-%m-%d %H:%M')
DATE=$(date '+%Y-%m-%d')

# Update Last updated timestamp
if grep -q '^\*\*Last updated:\*\*' .director/STATE.md; then
  if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "s/^\*\*Last updated:\*\*.*/\*\*Last updated:\*\* ${TIMESTAMP}/" .director/STATE.md
  else
    sed -i "s/^\*\*Last updated:\*\*.*/\*\*Last updated:\*\* ${TIMESTAMP}/" .director/STATE.md
  fi
fi

# Update Last session timestamp
if grep -q '^\*\*Last session:\*\*' .director/STATE.md; then
  if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "s/^\*\*Last session:\*\*.*/\*\*Last session:\*\* ${DATE}/" .director/STATE.md
  else
    sed -i "s/^\*\*Last session:\*\*.*/\*\*Last session:\*\* ${DATE}/" .director/STATE.md
  fi
fi

exit 0
```

Make it executable: `chmod +x scripts/state-save.sh`

**Update `hooks/hooks.json`** to add the SessionEnd hook. The research identified that the existing format may not match official Claude Code docs. Follow this approach:
- Keep the existing format structure (flat array with `event` field) since it has been working since Phase 1
- Add a new entry for SessionEnd in the same style

The updated hooks.json should be:

```json
{
  "hooks": [
    {
      "event": "SessionStart",
      "matcher": "startup",
      "command": "${CLAUDE_PLUGIN_ROOT}/scripts/session-start.sh",
      "timeout": 5,
      "statusMessage": "Loading Director..."
    },
    {
      "event": "SessionEnd",
      "command": "${CLAUDE_PLUGIN_ROOT}/scripts/state-save.sh",
      "timeout": 5
    }
  ]
}
```

NOTE: Keep the existing format (flat array) rather than switching to the nested event-keyed format. The existing format has been working since Phase 1 and changing formats mid-project introduces risk. If the nested format is truly required, that can be addressed in a future phase.

**Update `scripts/session-start.sh`** to also extract and output the `last_session` field from STATE.md:

Add after the existing CURRENT_TASK extraction:
```bash
LAST_SESSION=$(grep -m1 '^\*\*Last session:\*\*' .director/STATE.md 2>/dev/null | sed 's/\*\*Last session:\*\* //' || echo "unknown")
```

Update the JSON output to include last_session:
```bash
cat << EOF
{"director":{"status":"${STATUS}","goal":"${CURRENT_GOAL}","step":"${CURRENT_STEP}","task":"${CURRENT_TASK}","mode":"${MODE}","last_session":"${LAST_SESSION}"}}
EOF
```
  </action>
  <verify>
Run `bash -n scripts/state-save.sh` and `bash -n scripts/session-start.sh` to check syntax. Verify state-save.sh is executable with `ls -la scripts/state-save.sh`. Verify hooks.json is valid JSON with `python3 -c "import json; json.load(open('hooks/hooks.json'))"`. Grep for "last_session" in session-start.sh output section. Grep for "SessionEnd" in hooks.json.
  </verify>
  <done>
state-save.sh exists, is executable, and updates only Last updated and Last session timestamps in STATE.md. hooks.json registers both SessionStart and SessionEnd hooks. session-start.sh outputs last_session in its JSON context for resume awareness.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/init-director.sh` exits cleanly (no syntax errors)
2. `bash -n scripts/state-save.sh` exits cleanly
3. `bash -n scripts/session-start.sh` exits cleanly
4. `python3 -c "import json; json.load(open('hooks/hooks.json'))"` succeeds
5. STATE.md template in init script contains all 6 sections
6. state-save.sh is cross-platform (macOS + Linux sed handling)
7. session-start.sh JSON output includes last_session field
8. config-defaults.json includes cost_rate field
</verification>

<success_criteria>
- New Director projects initialized with `init-director.sh` get a STATE.md with Progress, Recent Activity, Decisions Log, and Cost Summary sections
- SessionEnd hook is registered and will update STATE.md timestamps on session exit
- SessionStart hook provides last_session date for resume awareness
- Config defaults include cost_rate for token-to-dollar conversion
- All scripts pass bash syntax checking
- hooks.json is valid JSON
</success_criteria>

<output>
After completion, create `.planning/phases/06-progress-continuity/06-01-SUMMARY.md`
</output>
