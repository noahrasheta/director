---
phase: 06-progress-continuity
plan: "02"
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - agents/director-syncer.md
  - skills/build/SKILL.md
autonomous: true

must_haves:
  truths:
    - "After every task, the syncer updates STATE.md with progress counts, activity log entry, cost estimate, and decisions"
    - "The build skill passes cost_data (context size in characters and current goal name) to the syncer"
    - "Cost estimates accumulate per goal in STATE.md, not per task or per step"
    - "The syncer logs key builder decisions in the Decisions Log section of STATE.md"
  artifacts:
    - path: "agents/director-syncer.md"
      provides: "Expanded syncer with cost tracking, activity logging, decisions extraction, and rich STATE.md updates"
      contains: "cost_data"
    - path: "skills/build/SKILL.md"
      provides: "Build skill passes cost_data to syncer in assembled context"
      contains: "cost_data"
  key_links:
    - from: "skills/build/SKILL.md"
      to: "agents/director-syncer.md"
      via: "Task tool spawning with cost_data XML section in context"
      pattern: "cost_data"
    - from: "agents/director-syncer.md"
      to: ".director/STATE.md"
      via: "Direct file writes to update Progress, Recent Activity, Decisions Log, and Cost Summary sections"
      pattern: "Recent Activity"
---

<objective>
Expand the syncer agent to manage the full STATE.md format, and update the build skill to pass cost data to the syncer.

Purpose: The syncer is the primary writer of STATE.md during normal operation (after every task). It must understand the expanded STATE.md format (from Plan 01) and correctly update progress counts, add activity log entries, accumulate cost estimates per goal, and extract key decisions from the builder's output. The build skill must provide the syncer with cost data so it can track token usage.

Output: Updated syncer agent with rich STATE.md management, updated build skill with cost_data in syncer context.
</objective>

<execution_context>
@/Users/noahrasheta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/noahrasheta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-progress-continuity/06-RESEARCH.md
@.planning/phases/06-progress-continuity/06-01-SUMMARY.md
@agents/director-syncer.md
@skills/build/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand syncer agent for rich STATE.md management</name>
  <files>agents/director-syncer.md</files>
  <action>
Rewrite the syncer agent to handle the expanded STATE.md format. Keep the existing structure (YAML frontmatter, role description, context expectations, scope rules, output format) but significantly expand the "Sync Process" section and add cost/decisions handling.

**Keep unchanged:**
- YAML frontmatter (name, description, tools, model: haiku, maxTurns: 20)
- Context You Receive section (but add `<cost_data>` to the list)
- Scope Rules table (unchanged)
- Important Rules section (unchanged)
- If Context Is Missing section (unchanged)

**Add to "Context You Receive":**
- `<cost_data>` -- Context size in characters and current goal name. Used to estimate and accumulate token costs.

**Rewrite the "Sync Process" section to include these steps:**

### 1. Understand what changed
(Keep existing -- read task description, identify what was built)

### 2. Update STATE.md -- Current Position
- Update `**Current goal:**`, `**Current step:**`, `**Current task:**` to reflect the NEXT ready task (not the just-completed one)
- Update `**Position:**` to the human-readable path (e.g., "Goal 1 > Step 2 > Task 4")
- Update `**Status:**` to "Building" (or "Complete" if all goals are done)
- Update `**Last updated:**` to current timestamp

### 3. Update STATE.md -- Progress section
- Update the per-goal progress block: recalculate task counts by scanning `.done.md` files in each step's `tasks/` directory
- Update step completion counts within each goal
- Update step status indicators: `[complete]`, `[in progress]`, or no indicator for not started
- Format each goal block as:
```markdown
### Goal N: [goal name]
**Steps:** X of Y complete
**Tasks:** A of B complete
**Status:** [In progress / Complete / Not started]
**Cost:** ~NNK tokens (~$X.XX)

- Step 1: [name] [status] -- X/Y tasks
- Step 2: [name] [status] -- X/Y tasks
```

### 4. Rename completed task file
(Keep existing -- rename to .done.md)

### 5. Update STATE.md -- Recent Activity
- Add a new entry at the TOP of the Recent Activity list (most recent first)
- Format: `- [YYYY-MM-DD HH:MM] Completed: [plain-language description of what was built] (~NNK tokens)`
- Include the estimated token cost from the cost_data section
- Keep the last 10 entries maximum. If there are more than 10, remove the oldest ones.

### 6. Update STATE.md -- Decisions Log
- Read the builder's output (from `<changes>` or the task summary) for indications of significant choices
- Look for phrases like: "chose X over Y", "using X because", "decided to", "went with X instead of Y"
- If any found, add entry: `- [YYYY-MM-DD] [plain-language decision description]`
- If no notable decisions detected, skip this step (don't add noise)

### 7. Update STATE.md -- Cost Summary
- Read `<cost_data>` for context_chars and goal_name
- Calculate estimated tokens: `(context_chars / 4) * 2.5` (input tokens + estimated output/reasoning)
- Read `cost_rate` from `.director/config.json` (default: $10 per 1M tokens if not found)
- Calculate dollar amount: `estimated_tokens * cost_rate / 1_000_000`
- Add the estimated tokens to the current goal's `**Cost:**` line in the Progress section
- Update the `**Total:**` line in the Cost Summary section
- Update the cost table row for the current goal
- Use `~` prefix for all cost figures to indicate they are estimates (e.g., `~320K tokens (~$3.20)`)

### 8. Check GAMEPLAN.md and VISION.md
(Keep existing -- flag drift, never modify VISION.md)

**Update the "Output" section to reflect richer updates:**

**If updates were made:**

"Updated project state:
- Marked [task name] as complete
- Progress: [N] of [M] tasks done in [step name]
- Cost: ~[N]K tokens added to [goal name] (~$[X.XX] total)
- [If decisions logged: 'Logged decision: [brief]']
- Updated current position to [next task or step]"

IMPORTANT: The syncer must be idempotent for cost tracking. Include the task identifier (file path) in the Recent Activity entry so the syncer can check whether this task's cost was already added (preventing double-counting on retries).
  </action>
  <verify>
Read the updated syncer agent file. Verify it contains: "cost_data" in Context You Receive, all 8 numbered steps in Sync Process, cost calculation formula referencing chars/4 * 2.5, Recent Activity formatting with token counts, Decisions Log extraction logic, Cost Summary update logic.
  </verify>
  <done>
Syncer agent handles the full STATE.md format: progress counts from file system scanning, timestamped activity log with cost estimates, decisions extraction from builder output, per-goal cost accumulation using chars/4 * 2.5 formula, and cost table maintenance.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update build skill to pass cost_data to syncer</name>
  <files>skills/build/SKILL.md</files>
  <action>
Update the build skill's Step 7 (Spawn builder) instructions section and Step 9 (Post-task sync verification) to include cost data in the syncer's context.

**In Step 5e (Instructions section)**, after the line about spawning director-syncer, add guidance about including cost data:

Update the instructions template to include:
```
After verification passes, spawn director-syncer with the task context, a summary of what changed, AND a cost_data section. The cost_data section must include:
- context_chars: the total character count of the assembled context from Step 5 (vision + step + task + git log + instructions)
- goal: the name of the current goal being worked on

Format the cost_data as:
<cost_data>
Context size: [N] characters
Estimated tokens: [N / 4 * 2.5, rounded to nearest thousand]
Goal: [current goal name from Step 4]
</cost_data>
```

**In Step 5f (Context budget calculation)**, after the budget estimation, add a note:

"Store the total character count of the assembled context (before any truncation). This value is needed for cost tracking in the syncer context (see instructions template above)."

These are targeted additions. Do NOT rewrite the entire build skill -- only modify Steps 5e and 5f. The rest of the 10-step pipeline is unchanged.
  </action>
  <verify>
Read the updated build skill. Grep for "cost_data" to confirm it appears in the instructions template. Grep for "context_chars" or "character count" to confirm the cost tracking data is referenced. Verify the rest of the build skill (Steps 1-4, 6-8, 10) is unchanged by comparing line counts or spot-checking key sections.
  </verify>
  <done>
Build skill passes cost_data (context size in characters and current goal name) to the syncer as part of the post-task context assembly. The syncer receives this data to calculate and accumulate token cost estimates per goal.
  </done>
</task>

</tasks>

<verification>
1. Syncer agent file contains all 8 sync process steps
2. Syncer references cost_data in its context expectations
3. Syncer has cost calculation formula (chars/4 * 2.5)
4. Syncer has idempotency check for cost tracking (task identifier in activity log)
5. Build skill includes cost_data in syncer context assembly
6. Build skill stores character count for cost tracking
7. No unintended changes to build skill Steps 1-4, 6-8, 10
</verification>

<success_criteria>
- The syncer agent can update all 6 sections of the expanded STATE.md format
- Cost estimates are calculated from context size and accumulated per goal
- The build skill provides the syncer with cost_data containing character count and goal name
- Activity log entries include task cost estimates
- Decisions are extracted from builder output when notable choices are made
- Cost tracking is idempotent (no double-counting on retries)
</success_criteria>

<output>
After completion, create `.planning/phases/06-progress-continuity/06-02-SUMMARY.md`
</output>
