---
phase: 08-pivot-brainstorm
plan: "02"
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - skills/pivot/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Pivot checks for uncommitted changes before proceeding and offers to complete current task or stash"
    - "Pivot spawns the mapper agent only when the project state is stale"
    - "Pivot skips the mapper and trusts existing docs when state is fresh"
    - "Mapper findings are presented conversationally to the user before impact analysis"
  artifacts:
    - path: "skills/pivot/SKILL.md"
      provides: "Pivot skill Steps 4-5 added: in-progress work check, conditional mapper spawning"
      min_lines: 160
  key_links:
    - from: "skills/pivot/SKILL.md"
      to: "agents/director-mapper.md"
      via: "Task tool spawning when stale"
      pattern: "director-mapper"
---

<objective>
Add pivot Steps 4-5 to the existing skill file -- checking for in-progress work (uncommitted changes, task in flight) and conditionally spawning the mapper agent when the codebase state is stale. This ensures pivots start from a clean commit state and have an accurate picture of what exists.

Purpose: Steps 4-5 are the "gather information" phase of pivot. Step 4 prevents data loss by ensuring a clean working tree. Step 5 decides whether the existing documentation is sufficient or whether a fresh codebase map is needed, avoiding unnecessary mapper spawns for recent projects.

Output: Updated `skills/pivot/SKILL.md` with Steps 4-5 inserted before the placeholder marker.
</objective>

<execution_context>
@/Users/noahrasheta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/noahrasheta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-pivot-brainstorm/08-CONTEXT.md
@.planning/phases/08-pivot-brainstorm/08-RESEARCH.md
@.planning/phases/08-pivot-brainstorm/08-01-SUMMARY.md

@skills/pivot/SKILL.md
@skills/build/SKILL.md
@agents/director-mapper.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pivot Steps 4-5 (in-progress work check and conditional mapper spawning)</name>
  <files>skills/pivot/SKILL.md</files>
  <action>
Read the current `skills/pivot/SKILL.md` (which has Steps 1-3 from plan 08-01). Replace the `<!-- Steps 4-9 -->` placeholder with Steps 4-5 and update the placeholder to `<!-- Steps 6-9 will be added in plans 08-03 and 08-04 -->`.

**Step 4: In-progress work check**
- Run `git status --porcelain` to check for uncommitted changes.
- If uncommitted changes exist: "I noticed some unsaved work in your project. Let's finish that up before we pivot -- it's easier to change direction from a clean state." Offer two options: (1) "Want me to save your current work first?" (git stash or commit), or (2) "Or set it aside temporarily?" (stash). Handle the user's response.
- Per locked decision: "complete current task first, then pivot from clean commit state. User can /director:undo after if they want to abandon that task."
- Reframe this conversationally: "It's easier to change direction from a clean state. Want to wrap up what you're working on first?"
- Only proceed once `git status --porcelain` returns empty.

**Step 5: Assess and map current state**
- Read `.director/STATE.md` to understand current project progress.
- Apply staleness heuristics to decide whether to spawn the mapper:

  Spawn mapper if ANY of these are true:
  - STATE.md Recent Activity shows many completed tasks since last mapping (more than a full step's worth of work)
  - STATE.md Last Session date is weeks or more in the past (significant time gap)
  - User explicitly mentioned working outside Director ("I've been building stuff manually", "I changed things directly")
  - The pivot is strategic (direction change) and the user needs to understand what exists

  Skip mapper if ANY of these are true:
  - Last session was recent (within a day or two)
  - Only a few tasks completed since last mapping
  - The pivot is about future direction ("I want to change what I'm building next"), not about what currently exists
  - User's pivot description provides enough context about current state

- If spawning mapper: tell the user "Let me check what your project looks like right now." Then spawn `director-mapper` via Task tool with instructions: "Map this codebase with a focus on what currently exists. The user is considering a change in direction: [pivot context from Step 2]. Report your findings using your standard output format." Run mapper in foreground. Present findings conversationally: "Here's what your project looks like right now:" followed by mapper findings formatted naturally.
- If skipping mapper: summarize current state from STATE.md and GAMEPLAN.md. Present as: "Based on where things stand:" followed by a brief summary of goals completed, current position, and what's in progress.
- In both cases, the current state summary is stored internally for use in Step 6 (impact analysis).

**Pattern references:**
- Mapper spawning pattern: same as brownfield onboarding (Phase 2, Plan 02) -- foreground, Task tool, conversational presentation of findings
- Uncommitted changes pattern: same as build skill Step 6
- Staleness is a judgment call, not a precise calculation (research recommendation)
  </action>
  <verify>
Read `skills/pivot/SKILL.md` and verify:
1. Step 4 checks `git status --porcelain`
2. Step 4 offers to stash or commit uncommitted changes
3. Step 4 waits for clean state before proceeding
4. Step 5 reads STATE.md for staleness assessment
5. Step 5 has spawn/skip heuristics with specific indicators
6. Step 5 spawns director-mapper via Task tool when stale
7. Step 5 presents mapper findings conversationally
8. Step 5 summarizes from STATE.md/GAMEPLAN.md when fresh
9. Placeholder updated to Steps 6-9
10. File is at least 160 lines
  </verify>
  <done>
Pivot skill handles in-progress work (clean state enforcement) and conditionally spawns the mapper agent based on staleness heuristics. Fresh projects skip the mapper; stale projects get a full map. Mapper findings are presented conversationally before impact analysis begins.
  </done>
</task>

</tasks>

<verification>
- Uncommitted changes are handled before pivot proceeds (clean state requirement)
- Mapper spawning is conditional -- not triggered on every pivot per locked decision
- Mapper uses Task tool in foreground, same pattern as brownfield onboarding
- Staleness indicators are documented in the skill for Claude to evaluate
</verification>

<success_criteria>
- Steps 4-5 are cleanly inserted after Step 3 in the pivot skill
- In-progress work check follows build skill pattern
- Mapper spawning is conditional with clear heuristics
- Locked decisions honored: complete current task first, mapper only when stale
</success_criteria>

<output>
After completion, create `.planning/phases/08-pivot-brainstorm/08-02-SUMMARY.md`
</output>
