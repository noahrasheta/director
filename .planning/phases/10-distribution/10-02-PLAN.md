---
phase: 10-distribution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/self-check.sh
  - scripts/session-start.sh
autonomous: true

must_haves:
  truths:
    - "A self-check script verifies all Director components (skills, agents, hooks) are present"
    - "Self-check is quiet on success and conversational on failure (Phase 9 error patterns)"
    - "Session start hook checks for available updates once per session"
    - "Update notification uses a 2-second timeout and skips silently on failure"
  artifacts:
    - path: "scripts/self-check.sh"
      provides: "Component verification on first run"
      min_lines: 30
    - path: "scripts/session-start.sh"
      provides: "Session start with update check"
      contains: "version"
  key_links:
    - from: "scripts/self-check.sh"
      to: "skills/*/SKILL.md"
      via: "checks for expected skill files"
      pattern: "SKILL\\.md"
    - from: "scripts/self-check.sh"
      to: "agents/*.md"
      via: "checks for expected agent files"
      pattern: "agents/"
    - from: "scripts/session-start.sh"
      to: ".claude-plugin/plugin.json"
      via: "reads installed version"
      pattern: "plugin\\.json"
---

<objective>
Create the self-check script for first-run verification and add update notification to the session-start hook.

Purpose: Users need confidence that Director installed correctly (self-check on first run) and awareness when updates are available (once-per-session notification). Both mechanisms are runtime -- they execute during normal Director usage, not during installation.
Output: scripts/self-check.sh (component verification), updated scripts/session-start.sh (update notification logic).
</objective>

<execution_context>
@/Users/noahrasheta/.claude/get-shit-done/workflows/execute-plan.md
@/Users/noahrasheta/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-distribution/10-CONTEXT.md
@.planning/phases/10-distribution/10-RESEARCH.md
@scripts/session-start.sh
@scripts/state-save.sh
@hooks/hooks.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create self-check script</name>
  <files>scripts/self-check.sh</files>
  <action>
Create `scripts/self-check.sh` that verifies all Director components are present and functional. This script runs on the first command invocation after install (called by skills, not by hooks).

The script should:

1. Accept `CLAUDE_PLUGIN_ROOT` as an environment variable (default to script's own directory parent: `$(cd "$(dirname "$0")/.." && pwd)`).

2. Check for all 13 expected skills (each must have a SKILL.md):
   onboard, blueprint, build, quick, undo, inspect, status, resume, brainstorm, pivot, idea, ideas, help

3. Check for all 8 expected agents (each must have an .md file in agents/):
   director-interviewer, director-planner, director-researcher, director-mapper, director-builder, director-verifier, director-debugger, director-syncer

4. Check for hooks configuration: hooks/hooks.json must exist.

5. Check for plugin manifest: .claude-plugin/plugin.json must exist.

6. Output behavior:
   - On success (zero issues): exit 0, output nothing (quiet success per user decision)
   - On failure: output structured information following Phase 9 error patterns:
     - First line: "DIRECTOR_SELF_CHECK_FAILED"
     - Second line: count of issues
     - Then each issue on its own line prefixed with "  - "
     - Final line: a plain-language suggestion: "Some Director components are missing. This usually means the installation didn't complete. Try reinstalling: /plugin install director@director-marketplace"
     - Exit 1

7. Make the script executable (chmod +x).

The error message follows the three-part structure from Phase 9: what went wrong (components missing), why (installation didn't complete), what to do (reinstall command).
  </action>
  <verify>
Run `bash scripts/self-check.sh` from the repo root. It should exit 0 with no output (all components present). Verify the script checks for all 13 skills and 8 agents by reading the file.
  </verify>
  <done>Self-check script exists, is executable, verifies all 13 skills + 8 agents + hooks + plugin manifest, quiet on success, conversational on failure</done>
</task>

<task type="auto">
  <name>Task 2: Add update notification to session-start hook</name>
  <files>scripts/session-start.sh</files>
  <action>
Update `scripts/session-start.sh` to include an update check that runs once per session. The existing script reads STATE.md and outputs a JSON summary -- extend it, do not replace.

Add update check logic AFTER the existing STATE.md reading but BEFORE the final JSON output:

1. Read the installed version from `${CLAUDE_PLUGIN_ROOT:-.}/.claude-plugin/plugin.json` (parse the `version` field with python3 or grep/sed).

2. Attempt to fetch the latest version from GitHub. Use curl with a 2-second timeout to fetch the raw marketplace.json:
   `curl -sf --max-time 2 "https://raw.githubusercontent.com/noahrasheta/director/main/.claude-plugin/marketplace.json"`
   Parse the `plugins[0].version` field from the response.

3. If the fetch fails (network error, timeout), skip silently -- do NOT show any error. Just proceed with normal session start.

4. If fetch succeeds and the remote version differs from the installed version, add an `"update_available"` field to the JSON output with the new version string. Example:
   `{"director":{"status":"...","goal":"...","step":"...","task":"...","mode":"...","last_session":"...","update_available":"1.1.0"}}`

5. If versions match, do not add the `update_available` field (no notification needed).

6. The update check should NOT block session start. Keep the 2-second timeout strict. If anything fails, fall through to normal output.

Important: The existing session-start.sh logic must remain unchanged. The update check is additive. The script currently outputs JSON only when `.director/STATE.md` exists. When no project exists, it exits 0 with no output. Preserve this behavior -- the update check should ALSO only run when a project exists (user is actively using Director).

Do NOT modify hooks/hooks.json -- the existing SessionStart hook configuration already runs this script.
  </action>
  <verify>
Run `bash scripts/session-start.sh` from the repo root (no .director/ folder present). Verify it exits 0 with no output (unchanged behavior). Read the script and verify: (1) curl has --max-time 2, (2) network failure is handled silently, (3) update_available field is only added when versions differ, (4) existing STATE.md reading logic is preserved.
  </verify>
  <done>Session-start hook checks for updates once per session with 2-second timeout, adds update_available to JSON output when new version exists, fails silently on network errors, preserves all existing behavior</done>
</task>

</tasks>

<verification>
- `bash scripts/self-check.sh` exits 0 with no output (all components present in this repo)
- `test -x scripts/self-check.sh && echo "Executable"` prints "Executable"
- `grep 'max-time 2' scripts/session-start.sh` finds the timeout setting
- `grep 'update_available' scripts/session-start.sh` finds the update field logic
- Existing session-start JSON output format is preserved (grep for the original cat/EOF block)
</verification>

<success_criteria>
- Self-check verifies 13 skills, 8 agents, hooks config, and plugin manifest
- Self-check is quiet on success, uses Phase 9 error patterns on failure
- Session start checks for updates with 2-second timeout
- Network failures during update check are silently ignored
- All existing session-start behavior is preserved
</success_criteria>

<output>
After completion, create `.planning/phases/10-distribution/10-02-SUMMARY.md`
</output>
